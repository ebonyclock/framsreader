[
  {
    "name": "A touch of life",
    "_classname": "show",
    "info": "",
    "expdef": "standard",
    "code": "\n//by MacKo, 2004\n\n//TODO: removing too slow creatures (just like too big ones are removed)\n\nglobal g_nointeraction; //simulation steps when a creature does not pass life back\nglobal g_status;\nglobal g_lasttime; //for auto popsize\n\nfunction onLoad()\n{\n  Math.seed = Math.time;\n  Simulator.import(\"show_noevol.sim\");\n\n  var pop=Populations[0];\n  pop.nnsim = 2; //anyway is controlled directly for each creature\n  pop.death = 0;\n  pop.energy = 0;\n  pop.selfmask = pop.othermask = 0; //ignore collisions\n\n  World.wrldbnd = 2;\n  World.wrldsiz = 30;\n\n  TrackingCam.cam_chspeed = 0.1;\n  TrackingCam.cam_zoom = 1.2;\n\n  ShowProperties.popsize = 0;\n  ShowProperties_popsize_set();\n  ShowProperties.rule = 1;\n\n  Simulator.import(\"walking.gen\");\n  removeTooBig();\n  g_status = \"\";\n  g_nointeraction = 1000;\n  g_lasttime = Math.time;\n  GLDisplay.desiredsimspeed=200;\n}\n\nfunction inside(cr, x, y)\n{\n  if (cr.bboxLow.x < x && (cr.bboxLow.x + cr.bboxSize.x) > x &&\n      cr.bboxLow.y < y && (cr.bboxLow.y + cr.bboxSize.y) > y)\n    return 1;\n  else\n    return 0;\n}\n\nfunction freeze(c)\n{\n  c.user1 = null;\n  c.user2 = null;\n  c.user3 = null;\n}\n\n// user1 - life ticks left\n// user2 - who gave me life? (won't give life back to him)\n// user3 - how much time left to follow the user2 rule\n\nfunction collisions() //would be REALLY better to use the standard handler in expdef, but I preferred not to create a special expdef for this show only\n{\n  var i, j, c1, c2, alive = 0;\n  var pop=Populations[0];\n  for (i = 0;i < pop.size;i++)\n  {\n    c1 = pop[i];\n    if (c1.user1 != null)\n    {\n      if (c1.user1 > 0)\n        c1.user1 = c1.user1 - 1;\n      if (c1.user3!=null && c1.user3 > 0)\n        c1.user3 = c1.user3 - 1;\n      if (c1.user1 == 0)\n      {\n        freeze(c1);\n        g_status = c1.name + \" frozen\";\n      }\n    }\n    c1.nnenabled = (c1.user1 != null);\n    if (ShowProperties.rule != 0)\n      for (j = i + 1;j < pop.size;j++)\n      {\n        c2 = pop[j];\n        if (inside(c1, c2.bboxLow.x, c2.bboxLow.y) == 1 || inside(c1, c2.bboxLow.x + c2.bboxSize.x, c2.bboxLow.y) == 1 ||\n            inside(c1, c2.bboxLow.x, c2.bboxLow.y + c2.bboxSize.y) == 1 || inside(c1, c2.bboxLow.x + c2.bboxSize.x, c2.bboxLow.y + c2.bboxSize.y) == 1)\n        {\n          if (ShowProperties.rule == 1)\n          {\n            //            Simulator.print(\"#\" + i + \" \" + c1.user2 + \" \" + c2.user2);\n            if (c1.user1 && !c2.user1)\n            {\n              if (!(c1.user2 == c2.uid && c1.user3 > 0))\n              {\n                freeze(c1);\n                c2.user1 = 1000000;\n                c2.user2 = c1.uid;\n                c2.user3 = g_nointeraction;\n                g_status = c1.name + \" passes life to \" + c2.name;\n              }\n            }\n            else\n              if (c2.user1 && !c1.user1)\n              {\n                if (!(c2.user2 == c1.uid && c2.user3 > 0))\n                {\n                  freeze(c2);\n                  c1.user1 = 1000000;\n                  c1.user2 = c2.uid;\n                  c1.user3 = g_nointeraction;\n                  g_status = c2.name + \" passes life to \" + c1.name;\n                }\n              }\n          }\n          if (ShowProperties.rule == 2)\n          {\n            if (!c1.user1)\n            {\n              c1.user1 = 500;\n              g_status = c1.name + \" revived by \" + c2.name;\n            }\n            else\n              if (!c2.user1)\n              {\n                c2.user1 = 500;\n                g_status = c2.name + \" revived by \" + c1.name;\n              }\n          }\n        }\n      }\n    if (c1.user1 != null)\n      alive++;\n  }\n  if (alive == 0 && ShowProperties.rule != 0) //at least one should be alive\n  {\n    var cc = pop[int(Math.rnd01 * pop.size)];\n    if (ShowProperties.rule == 1)\n      cc.user1 = 1000000;\n    if (ShowProperties.rule == 2)\n      cc.user1 = 500;\n    g_status = cc.name + \" auto-revived...\";\n  }\n}\n\nfunction onSimStep()\n{\n  collisions();\n}\n\nfunction onShowStep()\n{\n  var i, d = [\"Double-click to freeze or revive creatures.\", \"Life is passed with a touch.\", \"Life is propagated with a touch, for some time.\"];\n  GLDisplay.banner = d[ShowProperties.rule] + \"\\n\" + g_status;\n  if (ShowProperties.popsize == 0)\n    autoPopsize();\n}\n\nfunction autoPopsize()\n{\n  if (Math.time - g_lasttime > 5.0)\n  {\n    g_lasttime = Math.time;\n    if ((GLDisplay.fps < (0.85*GLDisplay.maxfps)) && ExpProperties.MaxCreated > 3)\n      ExpProperties.MaxCreated--;\n    if ((GLDisplay.fps > (0.95*GLDisplay.maxfps)) && ExpProperties.MaxCreated < 10)\n      ExpProperties.MaxCreated++;\n  }\n}\n\nfunction removeTooBig()\n{\n  var i, m;\n  var pool=GenePools[0];\n  for (i = pool.size - 1;i >= 0;i--)\n  {\n    var g=pool[i];\n    m = Model.newFromGeno(g.geno);\n    if (m.bboxSize.x > World.wrldsiz / 5 || m.bboxSize.y > World.wrldsiz / 5)\n    {\n      Simulator.print(\"Removed \" + g.name + \", too big.\");\n      g.delete();\n    }\n  }\n}\n\nfunction onSelectionChange()\n{\n  if (CreatureSelection.count > 0)\n  {\n    var c = CreatureSelection.get(0), d = \"\";\n    if (ShowProperties.rule != 0)\n      d = \"You wished \";\n    if (c.user1 != null)\n    {\n      freeze(c);\n      g_status = d + c.name + \" frozen\";\n    }\n    else\n    {\n      c.user1 = 500;\n      g_status = d + c.name + \" revived\";\n    }\n    CreatureSelection.clear();\n  }\n}\n\nfunction ShowProperties_popsize_set()\n{\n  ExpProperties.MaxCreated = [5, 2, 3, 4, 9, 16][ShowProperties.popsize];\n}\n\nfunction ShowProperties_rule_set()\n{\n  var pop=Populations[0];\n  var i;\n  for (i = 0;i < pop.size;i++)\n    freeze(pop.get(i));\n}\n\n"
  },
  {
    "id": "popsize",
    "_classname": "property",
    "help": "\"Auto\" adjusts the number of performers to the speed of your computer.",
    "type": "d 0 5 ~Auto~2~3~4~9~16",
    "name": "Number of creatures"
  },
  {
    "id": "rule",
    "_classname": "property",
    "type": "d 0 2 ~in your double-click~passed with a touch~propagated with a touch, for some time",
    "name": "Life is"
  }
]